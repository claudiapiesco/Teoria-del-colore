<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mixer HSL + controllo luminanza (grigio medio)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.35; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; max-width: 980px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; }
    .row { display: grid; grid-template-columns: 140px 1fr 80px; gap: 10px; align-items: center; margin: 8px 0; }
    .rowSmall { display: grid; grid-template-columns: 260px 1fr 90px; gap: 10px; align-items: center; margin: 8px 0; }
    .swatches { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 10px; }
    .swatch { border: 1px solid #ddd; border-radius: 12px; padding: 10px; }
    .chip { height: 80px; border-radius: 10px; border: 1px solid rgba(0,0,0,.15); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; }
    .small { font-size: 12px; color: #444; }
    input[type="range"] { width: 100%; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; border: 1px solid #ddd; }
    .kpi { margin-top: 6px; display:flex; flex-wrap:wrap; gap:10px; }
    .kpi span { border: 1px solid #eee; padding: 4px 8px; border-radius: 999px; }
    .footer { max-width: 980px; margin-top: 14px; color: #333; font-size: 13px; }
    .split { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .muted { color:#555; }
  </style>
</head>
<body>
  <h1>Mixer HSL (tono–saturazione–luminosità) con controllo di luminanza “grigio medio”</h1>

  <div class="grid">
    <div class="card">
      <div class="pill"><b>Colore 1 (HSL)</b></div>
      <div class="row"><label for="h1">Tono H (0–360)</label><input id="h1" type="range" min="0" max="360" value="0"><span id="h1v" class="mono">0</span></div>
      <div class="row"><label for="s1">Saturazione S</label><input id="s1" type="range" min="0" max="100" value="100"><span id="s1v" class="mono">100</span></div>
      <div class="row"><label for="l1">Luminosità L</label><input id="l1" type="range" min="0" max="100" value="50"><span id="l1v" class="mono">50</span></div>
      <div class="kpi">
        <span><b>RGB1</b> <span class="mono" id="rgb1">—</span></span>
        <span><b>Y1</b> <span class="mono" id="Y1">—</span></span>
      </div>
      <div class="small">Y = luminanza relativa sRGB (0–100), calcolata su componenti linearizzate.</div>
    </div>

    <div class="card">
      <div class="pill"><b>Colore 2 (HSL)</b></div>
      <div class="row"><label for="h2">Tono H (0–360)</label><input id="h2" type="range" min="0" max="360" value="120"><span id="h2v" class="mono">120</span></div>
      <div class="row"><label for="s2">Saturazione S</label><input id="s2" type="range" min="0" max="100" value="100"><span id="s2v" class="mono">100</span></div>
      <div class="row"><label for="l2">Luminosità L</label><input id="l2" type="range" min="0" max="100" value="50"><span id="l2v" class="mono">50</span></div>
      <div class="kpi">
        <span><b>RGB2</b> <span class="mono" id="rgb2">—</span></span>
        <span><b>Y2</b> <span class="mono" id="Y2">—</span></span>
      </div>
      <div class="small">Il mix è fatto in luce lineare RGB (più sensato su schermo).</div>
    </div>
  </div>

  <div class="card" style="max-width:980px; margin-top:18px;">
    <div class="split">
      <div>
        <div class="pill"><b>Mix</b></div>
        <div class="rowSmall">
          <label for="a">a (quota del colore 1)</label>
          <input id="a" type="range" min="0" max="1" step="0.01" value="0.50">
          <span id="av" class="mono">0.50</span>
        </div>
        <div class="small muted">
          Mix in luce lineare: <span class="mono">LinMix = a·Lin1 + (1−a)·Lin2</span>.
        </div>
      </div>

      <div>
        <div class="pill"><b>Controllo “grigio medio” (luminanza)</b></div>
        <div class="rowSmall">
          <label for="Lt">Target Y (0–100)</label>
          <input id="Lt" type="range" min="0" max="100" step="1" value="50">
          <span id="Ltv" class="mono">50</span>
        </div>
        <div class="rowSmall">
          <label for="tolL">Tolleranza (±)</label>
          <input id="tolL" type="range" min="0" max="20" step="1" value="2">
          <span id="tolLv" class="mono">2</span>
        </div>
        <div class="rowSmall">
          <label for="autoA">Auto: scegli a per raggiungere il target</label>
          <input id="autoA" type="checkbox" style="justify-self:start; transform: scale(1.2);">
          <span class="mono" id="asol">—</span>
        </div>
        <div class="small muted">
          In auto risolve <span class="mono">a = (Lt − Y2)/(Y1 − Y2)</span> (clamp 0–1), usando Y1 e Y2.
        </div>
      </div>
    </div>

    <div class="swatches">
      <div class="swatch">
        <div class="chip" id="chip1"></div>
        <div class="mono" id="c1txt" style="margin-top:8px;"></div>
      </div>
      <div class="swatch">
        <div class="chip" id="chip2"></div>
        <div class="mono" id="c2txt" style="margin-top:8px;"></div>
      </div>
      <div class="swatch">
        <div class="chip" id="chipm"></div>
        <div class="mono" id="cmtxt" style="margin-top:8px;"></div>
        <div class="kpi">
          <span><b>Ymix</b> <span class="mono" id="Ym">—</span></span>
          <span>Δ target <span class="mono" id="dY">—</span></span>
        </div>
        <div class="small" id="status" style="margin-top:6px;"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <b>Interpretazione (in linea con il libro):</b> “grigio medio” = luminanza del mix vicina al target (es. 50), entro una tolleranza.
  </div>

<script>
  const ids = ["h1","s1","l1","h2","s2","l2","a","Lt","tolL","autoA"];
  const el = Object.fromEntries(ids.map(id => [id, document.getElementById(id)]));
  const setText = (id, v) => document.getElementById(id).textContent = v;

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  // sRGB transfer functions
  function srgbToLinear(u){
    return (u <= 0.04045) ? (u/12.92) : Math.pow((u + 0.055)/1.055, 2.4);
  }
  function linearToSrgb(u){
    return (u <= 0.0031308) ? (12.92*u) : (1.055*Math.pow(u, 1/2.4) - 0.055);
  }

  // HSL -> sRGB (0..1)
  function hslToRgb01(h, s, l){
    h = ((h % 360) + 360) % 360;
    s = clamp01(s/100);
    l = clamp01(l/100);

    const c = (1 - Math.abs(2*l - 1)) * s;
    const hp = h / 60;
    const x = c * (1 - Math.abs((hp % 2) - 1));
    let r1=0,g1=0,b1=0;

    if (0 <= hp && hp < 1) { r1=c; g1=x; b1=0; }
    else if (1 <= hp && hp < 2) { r1=x; g1=c; b1=0; }
    else if (2 <= hp && hp < 3) { r1=0; g1=c; b1=x; }
    else if (3 <= hp && hp < 4) { r1=0; g1=x; b1=c; }
    else if (4 <= hp && hp < 5) { r1=x; g1=0; b1=c; }
    else { r1=c; g1=0; b1=x; }

    const m = l - c/2;
    return [r1+m, g1+m, b1+m];
  }

  function rgb01ToCss(rgb){
    const r = Math.round(clamp01(rgb[0])*255);
    const g = Math.round(clamp01(rgb[1])*255);
    const b = Math.round(clamp01(rgb[2])*255);
    return `rgb(${r}, ${g}, ${b})`;
  }

  function rgb01To255(rgb){
    return [
      Math.round(clamp01(rgb[0])*255),
      Math.round(clamp01(rgb[1])*255),
      Math.round(clamp01(rgb[2])*255)
    ];
  }

  // relative luminance (sRGB) from linear RGB
  function luminanceFromRgb01(rgb){
    const R = srgbToLinear(clamp01(rgb[0]));
    const G = srgbToLinear(clamp01(rgb[1]));
    const B = srgbToLinear(clamp01(rgb[2]));
    return 0.2126*R + 0.7152*G + 0.0722*B; // 0..1
  }

  function mixLinearRgb01(rgbA, rgbB, a){
    const Ra = srgbToLinear(clamp01(rgbA[0])), Ga = srgbToLinear(clamp01(rgbA[1])), Ba = srgbToLinear(clamp01(rgbA[2]));
    const Rb = srgbToLinear(clamp01(rgbB[0])), Gb = srgbToLinear(clamp01(rgbB[1])), Bb = srgbToLinear(clamp01(rgbB[2]));
    const Rm = a*Ra + (1-a)*Rb;
    const Gm = a*Ga + (1-a)*Gb;
    const Bm = a*Ba + (1-a)*Bb;
    return [linearToSrgb(Rm), linearToSrgb(Gm), linearToSrgb(Bm)];
  }

  function update(){
    const h1 = +el.h1.value, s1 = +el.s1.value, l1 = +el.l1.value;
    const h2 = +el.h2.value, s2 = +el.s2.value, l2 = +el.l2.value;
    let a  = +el.a.value;

    const Lt = +el.Lt.value;      // 0..100
    const tolL = +el.tolL.value;  // ±
    const auto = el.autoA.checked;

    setText("h1v", h1); setText("s1v", s1); setText("l1v", l1);
    setText("h2v", h2); setText("s2v", s2); setText("l2v", l2);
    setText("Ltv", Lt); setText("tolLv", tolL);

    const rgb1 = hslToRgb01(h1,s1,l1);
    const rgb2 = hslToRgb01(h2,s2,l2);

    const Y1 = luminanceFromRgb01(rgb1)*100;
    const Y2 = luminanceFromRgb01(rgb2)*100;

    if(auto){
      const denom = (Y1 - Y2);
      let aSol;
      if (Math.abs(denom) < 1e-9) aSol = 0.5;
      else aSol = (Lt - Y2) / denom;
      aSol = clamp01(aSol);
      a = aSol;
      el.a.value = a.toFixed(2);
      setText("asol", a.toFixed(2));
    } else {
      setText("asol", "—");
    }
    setText("av", a.toFixed(2));

    const rgbm = mixLinearRgb01(rgb1, rgb2, a);

    // Update swatches
    document.getElementById("chip1").style.background = rgb01ToCss(rgb1);
    document.getElementById("chip2").style.background = rgb01ToCss(rgb2);
    document.getElementById("chipm").style.background = rgb01ToCss(rgbm);

    const [R1,G1,B1] = rgb01To255(rgb1);
    const [R2,G2,B2] = rgb01To255(rgb2);
    const [Rm,Gm,Bm] = rgb01To255(rgbm);

    setText("rgb1", `(${R1}, ${G1}, ${B1})`);
    setText("rgb2", `(${R2}, ${G2}, ${B2})`);

    setText("Y1", Y1.toFixed(1));
    setText("Y2", Y2.toFixed(1));

    setText("c1txt", `HSL1 = (${h1}°, ${s1}%, ${l1}%)`);
    setText("c2txt", `HSL2 = (${h2}°, ${s2}%, ${l2}%)`);

    const Ym = luminanceFromRgb01(rgbm)*100;
    setText("Ym", Ym.toFixed(1));
    setText("cmtxt", `Mix RGB = (${Rm}, ${Gm}, ${Bm})`);

    const dY = (Ym - Lt);
    setText("dY", dY.toFixed(1));

    const ok = Math.abs(dY) <= tolL;
    document.getElementById("status").textContent =
      ok ? `Quasi “grigio medio” ✅ (entro ±${tolL})` : `Non “grigio medio” (fuori ±${tolL})`;
  }

  ids.forEach(id => el[id].addEventListener("input", update));
  el.autoA.addEventListener("change", update);
  update();
</script>
</body>
</html>
